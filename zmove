#!/bin/bash
# Move the given zettel to its new location

if [[ $# -ne 2 ]]; then
    echo "Usage: zmove <old> <new>"
    exit 1
fi

if [[ ! -v ZETTEL_DIR ]]; then
    echo "$(basename $0): $ZETTEL_DIR is not set"
    exit 1
fi

ext=txt

old="$1"
oldfull=
if [[ "$old" =~ ^[0-9]{3}[a-z-]*$ ]]; then
    oldfull="$(zdirectory $old)/$old.$ext"
elif [[ -e "$old" ]]; then
    oldfull=$old
    old=$(basename -s ".$ext" $oldfull)
else
    echo "zmove: Unable to figure out what file '$1' is"
    exit 1
fi
oldfull="${oldfull##$ZETTEL_DIR/}"

# Figure out where to move to
new="$2"
newfull=
if [[ "$new" =~ ^[0-9]{3}[a-z-]*$ ]]; then
    newfull="$(zdirectory $new)/$new.txt"
elif [[ "$new" =~ \.txt$ ]]; then
    # FIX: Hack, assumes that if a file has extension, then treat as fully
    # qualified.
    newfull=$new
    new=$(basename -s .txt $new)
else
    echo "zmove: Unable to figure out what file '$2' is"
    exit 1
fi
newfull="${newfull##$ZETTEL_DIR/}"

echo "zmove: Press [Enter] to move $oldfull to $newfull..."
read

# Move the files themselves
cd $ZETTEL_DIR
hg mv $oldfull $newfull
if [[ $? -ne 0 ]]; then
    echo "zmove: Mercurial could not move the file; aborting"
    exit 1
fi

# Change the title and add oldname, and then retouch to original modtime
sed -i -e "s/ยง$old\\./ยง$new\\./" $newfull
gawk -i inplace "NR==1,/^$/{sub(/^$/, \"oldname: ${old}\\n\")} 1" $newfull
zfix $newfull

# Find and replace all wiki links to $old with $new
if [[ "$oldfull" =~ ^(limbo|tech|personal)/.* ]]; then
    old="${BASH_REMATCH[1]}:$old"
fi
if [[ "$newfull" =~ ^(limbo|tech|personal)/.* ]]; then
    new="${BASH_REMATCH[1]}:$new"
fi
echo "zmove: Find and replace all wiki links to $old with $new..."
links=$(zlinksto $old)
echo "$links"
echo "zmove: Press [Enter] to replace the links..."
read
echo "$links" | zchangelinks $old $new
